<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestion Lessive ‚Äî Administrateur</title>
  <style>
    :root{
      --bg1:#1e0b2e; /* violet nuit */
      --bg2:#3b1a63; /* violet profond */
      --card:#20192b;
      --muted:#cfc8d9;
      --accent:#ff6ad5; /* rose */
      --accent-2:#7d5cff; /* violet n√©on */
      --green:#2ecc71;
      --blue:#3498db;
      --amber:#ffb300;
      --red:#ff5252;
      --radius:22px;
      --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:#fff;
      background: radial-gradient(1000px 600px at 100% -10%, #5b34b4 0%, transparent 60%),
                  radial-gradient(1000px 600px at -10% 110%, #e652a0 0%, transparent 60%),
                  linear-gradient(135deg,var(--bg1),var(--bg2));
    }

    /* √âcran 1 : s√©lection du membre */
    .select-screen{
      min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:28px; padding:24px;
    }
    .title{
      text-align:center;
      font-weight:800; letter-spacing:.3px; line-height:1.15;
    }
    .title .small{opacity:.85; font-size:1rem; font-weight:600}
    .title .big{font-size:clamp(1.6rem,3.5vw,2.6rem)}

    .members{
      display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:18px; width:min(1100px,100%);
    }
    .member-btn{
      border:none; cursor:pointer; padding:22px; border-radius:26px; color:#fff; font-weight:800; font-size:1.25rem; letter-spacing:.3px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow);
      transition: transform .15s ease, filter .15s ease;
    }
    .member-btn:hover{ transform: translateY(-3px); filter: brightness(1.05); }

    /* √âcran 2 : gestion */
    .screen{ display:none; min-height:100vh; }
    .screen.active{ display:flex; flex-direction:column; }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; flex-wrap:wrap; align-items:center; gap:10px; justify-content:space-between;
      padding:14px 18px; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(20,12,32,.65), rgba(20,12,32,.35));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.1);
      font-weight:700; font-size:.95rem;
    }
    .chip{ padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.12); font-weight:700; font-size:.85rem }
    .status-pill{ font-weight:800; padding:6px 10px; border-radius:999px; }
    .s-lessive{ background:rgba(52,152,219,.25); color:#cfe9ff; }
    .s-plie{ background:rgba(255,179,0,.25); color:#ffe6a6; }
    .s-armoire{ background:rgba(46,204,113,.25); color:#d9ffe6; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ border:none; cursor:pointer; border-radius:16px; padding:12px 16px; font-weight:800; color:#1c1330; background:#fff; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    .btn.primary{ background: linear-gradient(135deg, #ffd1ee, #d9d0ff); color:#321c57; }
    .btn.ghost{ background: rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.2) }

    .filters{ display:flex; gap:8px; flex-wrap:wrap; }
    select, input[type="search"]{
      appearance:none; border:none; outline:none;
      padding:12px 14px; border-radius:14px; background:rgba(255,255,255,.12); color:#fff; font-weight:600;
    }
    ::placeholder{ color:#e8defa99 }

    .grid{
      padding:20px; display:grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap:16px; align-items:stretch;
    }
    .card{
      position:relative; border-radius:var(--radius); overflow:hidden; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow); display:flex; flex-direction:column; isolation:isolate;
      transition: transform .12s ease, box-shadow .12s ease, background .2s ease;
    }
    .card:hover{ transform: translateY(-3px); box-shadow:0 12px 34px rgba(0,0,0,.35); }
    .card img{ width:100%; aspect-ratio: 1/1; object-fit:cover; background:#120a1d; }
    .card .meta{ display:flex; flex-direction:column; gap:6px; padding:12px; }
    .name{ font-weight:900; letter-spacing:.2px }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }

    /* S√©lection multi */
    .select-box{ position:absolute; top:10px; left:10px; width:26px; height:26px; border-radius:8px; background:rgba(255,255,255,.85); display:grid; place-items:center; font-weight:900; color:#351a67; box-shadow:var(--shadow); }
    .select-box input{ width:0; height:0; opacity:0; position:absolute }
    .card.selected{ outline:2px solid #ffd1ee; background:rgba(255,255,255,.12); }

    /* Modal d√©tails */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:22px; z-index:50; }
    .modal.open{ display:flex; }
    .modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(3px); }
    .modal .dialog{ position:relative; width:min(900px,96%); border-radius:26px; overflow:hidden; background:linear-gradient(180deg, rgba(29,16,54,.95), rgba(23,13,41,.95)); border:1px solid rgba(255,255,255,.1); box-shadow: var(--shadow); }
    .dialog .head{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08) }
    .dialog .body{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; padding:16px; }
    .dialog img{ width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:18px; background:#120a1d }
    .dialog .stack{ display:flex; flex-direction:column; gap:10px }
    .label{ opacity:.85; font-weight:700; font-size:.85rem }
    .field{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:10px 12px; color:#fff; font-weight:700 }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px }
    .close{ position:absolute; top:12px; right:12px; background:rgba(255,255,255,.14); color:#fff; border:none; border-radius:12px; padding:8px 10px; cursor:pointer }

    @media (max-width:820px){
      .dialog .body{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- √âcran 1 : s√©lection du membre -->
  <section id="select" class="select-screen">
    <div class="title">
      <div class="small">Gestion Lessive ‚Äî Interface Admin</div>
      <div class="big">Qui est en train de g√©rer ?</div>
    </div>
    <div class="members">
      <button class="member-btn" data-name="Omran">üë§ Omran</button>
      <button class="member-btn" data-name="Amir">üë§ Amir</button>
      <button class="member-btn" data-name="Youssof">üë§ Youssof</button>
      <button class="member-btn" data-name="Ahlam">üë§ Ahlam</button>
      <button class="member-btn" data-name="Loukman">üë§ Loukman</button>
    </div>
  </section>

  <!-- √âcran 2 : gestion -->
  <section id="manager" class="screen">
    <div class="topbar">
      <div class="tag" id="whoTag">üë§ <span id="who"></span></div>
      <div class="controls">
        <button class="btn ghost" id="changeUser">Changer</button>
        <button class="btn primary" id="addBtn">‚ûï Ajouter v√™tement</button>
        <button class="btn" id="bulkStatusBtn" disabled>üîÑ Changer statut (s√©lection)</button>
      </div>
      <div class="filters">
        <input id="search" type="search" placeholder="Rechercher (nom, commentaire)" />
        <select id="f-cat">
          <option value="">Toutes cat√©gories</option>
          <option>T-shirt</option>
          <option>Pantalon</option>
          <option>Short</option>
          <option>Veste</option>
        </select>
        <select id="f-status">
          <option value="">Tous statuts</option>
          <option value="lessive">Dans la lessive</option>
          <option value="plie">Pli√©</option>
          <option value="armoire">Dans l'armoire</option>
        </select>
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </section>

  <!-- Modal d√©tails -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="dialog">
      <button class="close" data-close>‚úï</button>
      <div class="head">
        <div class="title"><span class="big" id="m-name">Nom v√™tement</span></div>
        <div id="m-status" class="status-pill s-lessive">Dans la lessive</div>
      </div>
      <div class="body">
        <img id="m-photo" alt="photo v√™tement" />
        <div class="stack">
          <div>
            <div class="label">Cat√©gorie</div>
            <div id="m-cat" class="field">‚Äî</div>
          </div>
          <div>
            <div class="label">Commentaire</div>
            <div id="m-comment" class="field">‚Äî</div>
          </div>
          <div class="actions">
            <button class="btn" data-status="lessive">üß∫ Mettre ¬´ lessive ¬ª</button>
            <button class="btn" data-status="plie">üßª Mettre ¬´ pli√© ¬ª</button>
            <button class="btn" data-status="armoire">üóÑÔ∏è Mettre ¬´ armoire ¬ª</button>
            <button class="btn ghost" id="historyBtn">üìú Historique</button>
            <button class="btn" id="deleteBtn" style="background:linear-gradient(135deg,#ffd1d1,#ff8a8a);">üóëÔ∏è Supprimer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    //**
     * Int√©gration Firebase : App + Firestore + Storage (v10, modules ESM via CDN)
     */

    // --- Firebase (modules ESM) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, getDocs, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhJROpEyoGX0Hpm1QU8XirWjEqQK6eChE",
      authDomain: "suivie-lessive.firebaseapp.com",
      projectId: "suivie-lessive",
      storageBucket: "suivie-lessive.firebasestorage.app",
      messagingSenderId: "565381881043",
      appId: "1:565381881043:web:16e75adb9fcf9224f24826"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);
    const storage = getStorage(appFB);

    // --- √âtat en m√©moire ---
    let DATA = [];

    // Flux temps r√©el des v√™tements (ordonn√©s par dateModification desc si pr√©sent)
    const vetementsRef = collection(db, 'vetements');
    const qVet = query(vetementsRef);
    onSnapshot(qVet, (snap)=>{
      DATA = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      // tri c√¥t√© client par dateModification desc
      DATA.sort((a,b)=> (b.dateModification?.seconds||0) - (a.dateModification?.seconds||0));
      renderGrid();
    });

    const byId = (id)=>document.getElementById(id);
    const selectScreen = byId('select');
    const managerScreen = byId('manager');
    const who = byId('who');
    const whoTag = byId('whoTag');
    const grid = byId('grid');
    const bulkBtn = byId('bulkStatusBtn');
    const changeUserBtn = byId('changeUser');
    const addBtn = byId('addBtn');

    const search = byId('search');
    const fCat = byId('f-cat');
    const fStatus = byId('f-status');

    const modal = byId('modal');
    const mName = byId('m-name');
    const mStatus = byId('m-status');
    const mCat = byId('m-cat');
    const mComment = byId('m-comment');
    const mPhoto = byId('m-photo');

    let CURRENT_USER = null;
    // DATA est maintenant rempli par Firestore via onSnapshot()
    let SELECTION = new Set();
    let ACTIVE_DETAIL_ID = null;

    // ‚Äî‚Äî‚Äî‚Äî‚Äî √âtape 1 : choisir le membre
    document.querySelectorAll('.member-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        CURRENT_USER = btn.dataset.name;
        who.textContent = CURRENT_USER;
        selectScreen.style.display = 'none';
        managerScreen.classList.add('active');
        renderGrid();
      })
    });

    changeUserBtn.addEventListener('click', ()=>{
      managerScreen.classList.remove('active');
      selectScreen.style.display = 'flex';
      CURRENT_USER = null;
      who.textContent = '';
      SELECTION.clear();
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Rendu grille
    function statusPillClass(s){
      if(s==='lessive') return 'status-pill s-lessive';
      if(s==='plie') return 'status-pill s-plie';
      return 'status-pill s-armoire';
    }
    function statusLabel(s){
      return s==='lessive' ? 'Dans la lessive' : s==='plie' ? 'Pli√©' : "Dans l'armoire";
    }

    function renderGrid(){
      const q = (search.value||'').toLowerCase();
      const cat = fCat.value;
      const st = fStatus.value;
      const filtered = DATA.filter(x=>
        (!cat || x.categorie===cat) &&
        (!st || x.statut===st) &&
        (x.nom.toLowerCase().includes(q) || (x.commentaire||'').toLowerCase().includes(q))
      );

      grid.innerHTML = filtered.map(item=>{
        const selected = SELECTION.has(item.id) ? ' selected' : '';
        return `
          <article class="card${selected}" data-id="${item.id}">
            <label class="select-box">
              <input type="checkbox" ${SELECTION.has(item.id)?'checked':''} />
              ‚úì
            </label>
            <img src="${item.photo}" alt="${item.nom}" />
            <div class="meta">
              <div class="name">${item.nom}</div>
              <div class="row">
                <span class="chip">${item.categorie}</span>
                <span class="${statusPillClass(item.statut)}">${statusLabel(item.statut)}</span>
              </div>
            </div>
          </article>`
      }).join('');

      // Listeners apr√®s rendu
      grid.querySelectorAll('.card').forEach(card=>{
        const id = card.dataset.id;
        // Checkbox toggle
        card.querySelector('.select-box').addEventListener('click', (e)=>{
          e.stopPropagation();
          if(SELECTION.has(id)) SELECTION.delete(id); else SELECTION.add(id);
          renderGrid();
          updateBulkBtn();
        });
        // Ouvrir d√©tails
        card.addEventListener('click', ()=> openDetails(id));
      });

      updateBulkBtn();
    }

    function updateBulkBtn(){
      bulkBtn.disabled = SELECTION.size === 0;
    }

    // Filtres & recherche
    [search, fCat, fStatus].forEach(el=> el.addEventListener('input', renderGrid));

    // ‚Äî‚Äî‚Äî‚Äî‚Äî D√©tails
    function openDetails(id){
      const item = DATA.find(x=>x.id===id);
      if(!item) return;
      ACTIVE_DETAIL_ID = id;
      mName.textContent = item.nom;
      mPhoto.src = item.photo;
      mCat.textContent = item.categorie;
      mComment.textContent = item.commentaire || '‚Äî';
      mStatus.className = statusPillClass(item.statut);
      mStatus.textContent = statusLabel(item.statut);
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      ACTIVE_DETAIL_ID = null;
    }

    modal.querySelectorAll('[data-close]').forEach(el=> el.addEventListener('click', closeModal));

    // Actions de statut dans le modal
    modal.querySelectorAll('[data-status]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-status');
        setStatus(ACTIVE_DETAIL_ID, target, `Changement via d√©tails par ${CURRENT_USER}`);
        closeModal();
      });
    });

    // Bouton bulk (s√©lection)
    bulkBtn.addEventListener('click', ()=>{
      const target = prompt("Nouveau statut pour la s√©lection: lessive / plie / armoire", "plie");
      if(!target || !['lessive','plie','armoire'].includes(target)) return;
      [...SELECTION].forEach(id=> setStatus(id, target, `Bulk par ${CURRENT_USER}`));
      SELECTION.clear();
      renderGrid();
    });

    // (D√©mo) bouton Ajouter ‚Äî ici on simule l'ajout d'un v√™tement
    addBtn.addEventListener('click', async ()=>{
      if(!CURRENT_USER){ alert('Veuillez choisir un membre.'); return; }
      const nom = prompt('Nom du v√™tement ?');
      if(!nom) return;
      const categorie = prompt('Cat√©gorie ? (T-shirt / Pantalon / Short / Veste)', 'T-shirt') || 'T-shirt';
      const photoURL = prompt('URL de la photo (obligatoire)');
      if(!photoURL){ alert('Photo obligatoire.'); return; }
      const commentaire = prompt('Commentaire (optionnel)', '') || '';
      try{
        const ref = await addDoc(collection(db,'vetements'),{
          nom, categorie, photo: photoURL, statut:'lessive', commentaire,
          proprietaire: CURRENT_USER,
          dateCreation: serverTimestamp(),
          dateModification: serverTimestamp(),
          modifiePar: CURRENT_USER
        });
        await addDoc(collection(db,'historique'),{
          vetementId: ref.id, membre: CURRENT_USER, date: serverTimestamp(), action:`Ajout: ${nom}`
        });
      } catch(err){
        alert('Erreur ajout: '+err.message);
      }
    });
      if(!nom) return;
      const categorie = prompt('Cat√©gorie ? (T-shirt / Pantalon / Short / Veste)', 'T-shirt') || 'T-shirt';
      const photo = prompt('URL de la photo (obligatoire)', '') || '';
      if(!photo){ alert('Photo obligatoire.'); return; }
      const commentaire = prompt('Commentaire (optionnel)', '') || '';
      const id = String(Date.now());
      DATA.unshift({ id, nom, categorie, photo, statut:'lessive', commentaire, proprietaire: CURRENT_USER });
      // TODO: Firestore addDoc + Storage (quand branch√©)
      // TODO: Historique: "CURRENT_USER a ajout√© ..."
      renderGrid();
    });

    // (D√©mo) supprimer depuis modal
    document.getElementById('deleteBtn').addEventListener('click', async ()=>{
      if(!ACTIVE_DETAIL_ID) return;
      if(confirm('Supprimer ce v√™tement ?')){
        try{
          const ref = doc(db,'vetements',ACTIVE_DETAIL_ID);
          await deleteDoc(ref);
          await addDoc(collection(db,'historique'),{
            vetementId: ACTIVE_DETAIL_ID, membre: CURRENT_USER, date: serverTimestamp(), action:'Suppression'
          });
          closeModal();
        }catch(err){
          alert('Erreur suppression: '+err.message);
        }
      }
    });
        // TODO: Firestore deleteDoc
        closeModal();
        renderGrid();
      }
    });

    // Historique (placeholder)
    document.getElementById('historyBtn').addEventListener('click', async ()=>{
      if(!ACTIVE_DETAIL_ID) return;
      try{
        const qHist = query(collection(db,'historique'), where('vetementId','==',ACTIVE_DETAIL_ID), orderBy('date','desc'), limit(10));
        const snap = await getDocs(qHist);
        const lines = [];
        snap.forEach(d=>{
          const h = d.data();
          const ts = h.date?.seconds ? new Date(h.date.seconds*1000) : new Date();
          lines.push(`‚Ä¢ ${ts.toLocaleString()} ‚Äî ${h.membre}: ${h.action}`);
        });
        alert(lines.length ? lines.join('
') : 'Aucune entr√©e pour le moment.');
      }catch(err){
        alert('Erreur lecture historique: '+err.message);
      }
    });
    });

    function setStatus(id, statut, reason){
      const ref = doc(db,'vetements', id);
      updateDoc(ref, {
        statut,
        dateModification: serverTimestamp(),
        modifiePar: CURRENT_USER
      }).then(async ()=>{
        await addDoc(collection(db,'historique'),{
          vetementId: id,
          date: serverTimestamp(),
          membre: CURRENT_USER,
          action: reason || `Statut ‚Üí ${statut}`
        });
        renderGrid();
      }).catch(err=>{
        alert('Erreur mise √† jour statut: '+err.message);
      });
    }
  </script>
</body>
</html>
