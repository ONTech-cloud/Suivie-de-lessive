<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi Lessive – Gestion des vêtements</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#101735; --muted:#6b7294; --text:#e8ecff; --accent:#7aa2ff; --accent-2:#4dd1a1; --danger:#ff6b6b;
      --ring:rgba(122,162,255,.35); --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, #121a3a 0, transparent 60%),
                   radial-gradient(800px 600px at 120% 10%, #12233a 0, transparent 55%), var(--bg); color:var(--text);
         font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(10,15,30,.9), rgba(10,15,30,.55));
           backdrop-filter:saturate(140%) blur(10px); border-bottom:1px solid #1b244d}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}
    .btn{appearance:none;border:0;border-radius:14px;padding:10px 14px;font-weight:600;cursor:pointer;color:#0c1222;
         box-shadow:var(--shadow);transition:transform .08s ease, box-shadow .2s ease; background:linear-gradient(180deg,#a5bfff,#7297ff)}
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:linear-gradient(180deg,#cce9ff,#a8cfff);}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid #283168}
    .btn.danger{background:linear-gradient(180deg,#ff9c9c,#ff6b6b)}

    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:linear-gradient(180deg,#0f1632,#0b1128); border:1px solid #1b244d;border-radius:18px;overflow:hidden; box-shadow:var(--shadow)}
    .thumb{aspect-ratio:4/3;background:#0a1230; display:block; width:100%; object-fit:cover}
    .card .body{padding:12px}
    .meta{color:var(--muted);font-size:12px;margin-top:2px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(8,12,26,.6);backdrop-filter:blur(6px); display:none; align-items:center; justify-content:center; z-index:50}
    .modal.open{display:flex}
    .dialog{width:min(680px,92vw); background:linear-gradient(180deg,#0f1634,#0b1128); border:1px solid #1b244d; border-radius:20px; box-shadow:var(--shadow)}
    .dialog header{position:relative;background:transparent;border:0}
    .dialog h2{font-size:18px;margin:0}
    .dialog .content{padding:12px 16px 16px}
    .form{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .form .full{grid-column:1/-1}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input[type="text"], select, textarea{width:100%; background:#0a1230; color:var(--text); border:1px solid #263064; border-radius:12px; padding:10px 12px; outline:none}
    textarea{min-height:90px; resize:vertical}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
    .hint{font-size:12px;color:var(--muted)}
    .preview{display:grid; place-items:center; background:#0a1230; border:1px dashed #2a366e; border-radius:12px; aspect-ratio:4/3; overflow:hidden}
    .preview img{width:100%;height:100%;object-fit:cover}

    .chip{display:inline-flex;align-items:center;gap:6px;background:#0a1230;border:1px solid #253167;border-radius:999px;padding:4px 8px;font-size:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}

    .empty{opacity:.75;text-align:center;border:1px dashed #263168;border-radius:16px;padding:28px}
    .sr-only{position:absolute;left:-9999px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Suivi Lessive – Gestion des vêtements</h1>
      <div class="toolbar">
        <div class="hint">Ajoute, visualise et gère tes vêtements avec Firestore & Storage.</div>
        <button id="openModalBtn" class="btn">Ajouter un vêtement</button>
      </div>
    </div>
  </header>

  <main>
    <div id="itemsGrid" class="grid" aria-live="polite"></div>
    <div id="emptyState" class="empty" style="display:none">Aucun vêtement pour l’instant. Clique « Ajouter un vêtement » pour commencer.</div>
  </main>

  <!-- Modal de création -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle">
    <div class="dialog">
      <header class="wrap">
        <h2 id="dialogTitle">Ajouter un vêtement</h2>
      </header>
      <div class="content">
        <form id="addForm" class="form">

          <div class="full">
            <label for="photo">Photo</label>
            <div class="preview" id="dropZone">
              <input id="photo" name="photo" class="sr-only" type="file" accept="image/*" />
              <img id="imagePreview" alt="Aperçu" style="display:none" />
              <div id="dropZoneHint" class="hint">Glisse une image ici ou <u>clique pour choisir</u>.</div>
            </div>
          </div>

          <div>
            <label for="name">Nom *</label>
            <input id="name" name="name" type="text" required placeholder="ex. T-shirt bleu" />
          </div>

          <div>
            <label for="category">Catégorie *</label>
            <select id="category" name="category" required>
              <option value="">— Choisir —</option>
              <option>T-shirt</option>
              <option>Chemise</option>
              <option>Pantalon</option>
              <option>Pull</option>
              <option>Veste</option>
              <option>Linge</option>
              <option>Autre</option>
            </select>
          </div>

          <div class="full">
            <label for="comment">Commentaire</label>
            <textarea id="comment" name="comment" placeholder="Notes, état, couleur, etc."></textarea>
          </div>

          <div class="actions full">
            <button type="button" class="btn ghost" id="cancelBtn">Annuler</button>
            <button type="submit" class="btn" id="saveBtn">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <template id="itemTpl">
    <article class="card" data-id="">
      <img class="thumb" alt="Photo vêtement" />
      <div class="body">
        <div class="row">
          <strong class="title"></strong>
          <span class="chip"><span class="dot" style="width:8px;height:8px;border-radius:50%;background:var(--accent)"></span><span class="cat"></span></span>
        </div>
        <div class="meta comment" style="margin-top:6px"></div>
        <div class="row" style="margin-top:10px">
          <div class="meta date"></div>
          <div style="display:flex;gap:6px">
            <button class="btn secondary" data-action="edit">Éditer</button>
            <button class="btn danger" data-action="delete">Supprimer</button>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script type="module">
    // ==========================
    //  Firebase (v10, modules)
    // ==========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      initializeFirestore,
      persistentLocalCache,
      persistentMultipleTabManager,
      collection, addDoc, onSnapshot, query, orderBy,
      serverTimestamp, deleteDoc, doc, updateDoc,
      getFirestore
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ⚠️ Remplace ces valeurs par ta config Firebase du projet "suivie-lessive".
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "suivie-lessive",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);

    // IMPORTANT: cette config règle souvent les erreurs Listen 400 liées au transport WebChannel
    // (proxies, adblock, réseaux instables). On force la détection et active le cache persistant.
    const db = initializeFirestore(app, {
      localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() }),
      experimentalAutoDetectLongPolling: true
    });
    // getStorage / getFirestore si tu en as besoin ailleurs
    const storage = getStorage(app);

    // ==========================
    //  Sélecteurs UI
    // ==========================
    const openModalBtn = document.getElementById('openModalBtn');
    const modal = document.getElementById('modal');
    const addForm = document.getElementById('addForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const photoInput = document.getElementById('photo');
    const dropZone = document.getElementById('dropZone');
    const previewImg = document.getElementById('imagePreview');
    const dropHint = document.getElementById('dropZoneHint');

    const itemsGrid = document.getElementById('itemsGrid');
    const emptyState = document.getElementById('emptyState');

    const vetementsCol = collection(db, 'vetements');
    const q = query(vetementsCol, orderBy('createdAt', 'desc'));

    // ==========================
    //  Helpers UI
    // ==========================
    function openModal(){ modal.classList.add('open'); }
    function closeModal(){ modal.classList.remove('open'); addForm.reset(); previewImg.style.display='none'; dropHint.style.display='block'; previewImg.src=''; }

    openModalBtn.addEventListener('click', openModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

    // Drop zone / Preview
    dropZone.addEventListener('click', () => photoInput.click());
    dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; });
    dropZone.addEventListener('dragleave', ()=>{ dropZone.style.borderColor = '#2a366e'; });
    dropZone.addEventListener('drop', (e)=>{
      e.preventDefault();
      dropZone.style.borderColor = '#2a366e';
      if(e.dataTransfer.files && e.dataTransfer.files[0]){
        photoInput.files = e.dataTransfer.files; // assigner
        updatePreview();
      }
    });
    photoInput.addEventListener('change', updatePreview);

    function updatePreview(){
      const file = photoInput.files?.[0];
      if(!file){ previewImg.style.display='none'; dropHint.style.display='block'; previewImg.src=''; return; }
      const reader = new FileReader();
      reader.onload = () => { previewImg.src = reader.result; previewImg.style.display='block'; dropHint.style.display='none'; };
      reader.readAsDataURL(file);
    }

    function fmtDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if(!d) return '';
        return new Intl.DateTimeFormat('fr-FR',{ dateStyle:'medium', timeStyle:'short' }).format(d);
      }catch{ return ''; }
    }

    // ==========================
    //  Rendu liste (temps réel)
    // ==========================
    onSnapshot(q, (snap) => {
      itemsGrid.innerHTML = '';
      if(snap.empty){ emptyState.style.display='block'; return; } else { emptyState.style.display='none'; }
      const tpl = document.getElementById('itemTpl');
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.dataset.id = docSnap.id;
        node.querySelector('.thumb').src = data.imageUrl || 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 120"><rect width="100%" height="100%" fill="#0a1230"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#32417a" font-family="Inter,system-ui" font-size="12">Aucune image</text></svg>`);
        node.querySelector('.title').textContent = data.name || 'Sans nom';
        node.querySelector('.cat').textContent = data.category || '—';
        node.querySelector('.comment').textContent = data.comment || '';
        node.querySelector('.date').textContent = fmtDate(data.createdAt) || '';

        node.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if(!btn) return;
          const action = btn.dataset.action;
          if(action==='delete') return handleDelete(docSnap.id, data.imagePath);
          if(action==='edit') return handleEdit(docSnap.id, data);
        });
        itemsGrid.appendChild(node);
      });
    }, (err) => {
      console.error('Erreur Firestore onSnapshot', err);
      // Petit fallback visuel
      emptyState.style.display='block';
      emptyState.textContent = 'Erreur de connexion en temps réel. Vérifie la config ou le réseau.';
    });

    // ==========================
    //  Création
    // ==========================
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      saveBtn.disabled = true; saveBtn.textContent = 'Enregistrement…';

      const name = addForm.name.value.trim();
      const category = addForm.category.value.trim();
      const comment = addForm.comment.value.trim();
      if(!name || !category){
        alert('Nom et catégorie sont obligatoires.');
        saveBtn.disabled=false; saveBtn.textContent='Enregistrer';
        return;
      }

      let imageUrl = '';
      let imagePath = '';
      try {
        const file = photoInput.files?.[0];
        if(file){
          const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g,'_');
          const path = `vetements/${Date.now()}_${safeName}`;
          const ref = storageRef(storage, path);
          await uploadBytes(ref, file);
          imageUrl = await getDownloadURL(ref);
          imagePath = path;
        }

        await addDoc(vetementsCol, {
          name, category, comment, imageUrl, imagePath,
          createdAt: serverTimestamp()
        });

        closeModal();
      } catch (err) {
        console.error(err);
        alert('Échec de la sauvegarde: ' + (err?.message || err));
      } finally {
        saveBtn.disabled=false; saveBtn.textContent='Enregistrer';
      }
    });

    // ==========================
    //  Suppression
    // ==========================
    async function handleDelete(id, path){
      if(!confirm('Supprimer ce vêtement ?')) return;
      try{
        await deleteDoc(doc(db, 'vetements', id));
        if(path){
          try{ await deleteObject(storageRef(storage, path)); }catch(e){ console.warn('Suppression image ignorée:', e?.message||e); }
        }
      }catch(err){ alert('Échec de la suppression: ' + (err?.message||err)); }
    }

    // ==========================
    //  Édition minimale (inline via prompt)
    //  → Tu pourras plus tard remplacer par un modal d’édition si tu veux.
    // ==========================
    async function handleEdit(id, data){
      const name = prompt('Nom', data.name || '')?.trim();
      if(name==null) return; // annulé
      const category = prompt('Catégorie', data.category || '')?.trim();
      if(category==null) return;
      const comment = prompt('Commentaire', data.comment || '')?.trim();
      if(comment==null) return;
      try{
        await updateDoc(doc(db, 'vetements', id), { name, category, comment });
      }catch(err){ alert('Échec de la mise à jour: ' + (err?.message||err)); }
    }

  </script>
</body>
</html>
